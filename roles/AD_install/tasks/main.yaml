---
# Basic runtime dependencies
- name: Ensure python3 present (skip if already installed)
  become: true
  ansible.builtin.apt:
    name:
      - python3
      - python3-apt
    state: present
    update_cache: true
    force_apt_get: true
  register: py_pkgs
  retries: 3
  delay: 5
  until: py_pkgs is succeeded
  failed_when: false

- name: Install utils (with docker)
  become: true
  ansible.builtin.apt:
    name: "{{ base_utils }}"
    state: present
    update_cache: true
    force_apt_get: true
  register: utils_pkgs
  retries: 3
  delay: 5
  until: utils_pkgs is succeeded

# Optional iptables rules deployment
- name: Install iptables-persistent
  become: true
  ansible.builtin.apt:
    name: iptables-persistent
    state: present
    update_cache: false
    force_apt_get: true
  when: iptables_apply | bool

- name: Deploy iptables rules file
  become: true
  ansible.builtin.copy:
    src: "iptables/{{ iptables_ruleset }}"
    dest: /etc/iptables/rules.v4
    owner: root
    group: root
    mode: '0644'
  notify: Save iptables rules
  when: iptables_apply | bool

- name: Apply iptables rules via iptables-restore
  become: true
  ansible.builtin.command: iptables-restore /etc/iptables/rules.v4
  when: iptables_apply | bool

# Firegex setup (standalone mode, non-interactive)
- name: Stop firegex standalone if running
  become: true
  ansible.builtin.shell: |
    set -e
    if [ -f /root/firegex.py ]; then
      python3 /root/firegex.py stop --standalone || true
    fi
  args:
    executable: /bin/bash
  when: install_firegex | bool

- name: Unmount firegex bind mounts if present
  become: true
  ansible.builtin.shell: |
    set -e
    if mount | grep -q '/root/firegexfs'; then
      mount | awk '$3 ~ "^/root/firegexfs" {print length($3), $3}' | sort -nr | cut -d" " -f2- | while read m; do
        umount -l "$m" || true
      done
    fi
  args:
    executable: /bin/bash
  when: install_firegex | bool

- name: Clean previous firegex install artifacts
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /root/firegexfs
    - /opt/firegex
    - /root/firegex.py
  when: install_firegex | bool

- name: Download firegex installer
  become: true
  ansible.builtin.get_url:
    url: "{{ firegex_repo_url }}"
    dest: /tmp/firegex.sh
    mode: '0755'
  when: install_firegex | bool

- name: Install firegex (standalone, non-interactive)
  become: true
  ansible.builtin.shell: |
    set -e
    LOGFILE=/var/log/firegex-install.log
    : > "$LOGFILE"
    /usr/bin/expect <<'EOF' | tee -a "$LOGFILE"
    set timeout -1
    set pass "{{ firegex_password }}"
    spawn sh /tmp/firegex.sh --standalone
    expect "Insert a password for firegex:"
    send "$pass\r"
    expect "Confirm the password:"
    send "$pass\r"
    expect eof
    EOF
  args:
    executable: /bin/bash
  when: install_firegex | bool

- name: Check firegex status
  become: true
  ansible.builtin.shell: |
    set -e
    if [ -f /root/firegex.py ]; then
      python3 /root/firegex.py status --standalone
    else
      exit 1
    fi
  args:
    executable: /bin/bash
  register: firegex_status
  changed_when: false
  failed_when: firegex_status.rc != 0
  when: install_firegex | bool

- name: Show firegex status output
  ansible.builtin.debug:
    msg: "{{ firegex_status.stdout_lines | default([]) }}"
  when: install_firegex | bool
